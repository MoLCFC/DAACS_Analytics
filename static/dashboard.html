<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAACS Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" integrity="sha512-4xo8blKMVCiXpTaLzQSLSw3KFOVPWhm/TRtuPVc4WG6kUgjH6J03IBuG7JZPkcWMxJ5huwaBpOpnwYElP/m6wg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/static/charts.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111c3a;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.15);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
            --card-shadow: 0 18px 48px rgba(15, 23, 42, 0.45);
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(165deg, #050b1f 0%, #16213e 45%, #111827 100%);
            color: var(--text-primary);
            margin: 0;
            padding: 0 0 60px;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 32px 60px 12px;
        }
        .branding {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .branding img { height: 48px; }
        .branding h1 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        .status {
            padding: 12px 22px;
            border-radius: 999px;
            background: rgba(34, 197, 94, 0.16);
            color: #bbf7d0;
            font-weight: 600;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 50px;
        }
        h2.section-title {
            font-size: 1.4rem;
            margin: 40px 0 18px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .card {
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(12px);
        }
        .card h3 {
            margin: 0 0 8px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .card .value {
            font-size: 2.4rem;
            font-weight: 700;
            margin: 6px 0 0;
        }
        .card .value.small { font-size: 1.8rem; }
        .card .muted { color: var(--text-secondary); margin-top: 6px; }
        .panel {
            background: rgba(15, 23, 42, 0.68);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 28px;
            margin-bottom: 32px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }
        .panel h3 {
            margin: 0 0 14px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
        }
        .filters input, .filters select {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.75);
            color: var(--text-primary);
            flex: 1;
        }
        .filters button {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            font-weight: 600;
            letter-spacing: 0.04em;
            cursor: pointer;
        }
        table.data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.95rem;
        }
        table.data-table th,
        table.data-table td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.16);
            text-align: left;
        }
        table.data-table th { background: rgba(79, 70, 229, 0.12); }
        .pill-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .pill {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.16);
            color: #b4c1ff;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }
        .traction-light svg { display: block; }
        .empty {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            padding: 18px;
            color: var(--text-secondary);
            text-align: center;
        }
        .dual-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }
        table.data-table td svg { display: inline-block; vertical-align: middle; }
        .name-with-id { display: flex; align-items: center; gap: 6px; }
        .name-with-id .info {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.2);
            color: rgba(148, 163, 184, 0.95);
            font-size: 0.75rem;
            cursor: help;
        }
        .autocomplete { position: relative; flex: 1; }
        .autocomplete input { width: 100%; }
        #user-suggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 4px);
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            list-style: none;
            margin: 0;
            padding: 4px 0;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.45);
            z-index: 40;
        }
        #user-suggestions li {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        #user-suggestions li:hover,
        #user-suggestions li.active {
            background: rgba(99, 102, 241, 0.25);
        }
        #user-suggestions li .muted { font-size: 0.8rem; }
        .traffic-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .traffic-cell span { color: var(--text-secondary); font-size: 0.85rem; }
        .nav-legend { margin-top: 12px; color: var(--text-secondary); font-size: 0.85rem; }
        .autocomplete { position: relative; flex: 1; }
        .autocomplete input { width: 100%; }
        #user-suggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            list-style: none;
            margin: 4px 0 0 0;
            padding: 0;
            max-height: 220px;
            overflow-y: auto;
            z-index: 30;
        }
        #user-suggestions li {
            padding: 10px 14px;
            cursor: pointer;
        }
        #user-suggestions li:hover,
        #user-suggestions li.active {
            background: rgba(99, 102, 241, 0.25);
        }
    </style>
</head>
<body>
    <header>
        <div class="branding">
            <img src="/static/DAACS_logo-small.png" alt="DAACS" />
            <h1>DAACS Insights Control Center</h1>
        </div>
        <div id="status" class="status">Starting diagnostics…</div>
    </header>

    <div class="dashboard">
        <section class="cards" id="overview-cards"></section>

        <section class="panel">
            <h3>Performance Distribution</h3>
            <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">This chart shows how assessment scores are distributed across banded score ranges. Taller bars indicate more attempts falling within that score band.</p>
            <div id="distribution-chart" style="margin-bottom:28px;"></div>
            <div id="distribution-summary" class="cards"></div>
        </section>

        <section class="dual-panel">
            <div class="panel">
                <h3>User Growth</h3>
                <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Bar chart of new users created per day within the selected date range.</p>
                <div class="filters">
                    <input id="users-start" type="date" />
                    <input id="users-end" type="date" />
                    <button id="users-apply">Apply</button>
                </div>
                <div id="users-created-chart"></div>
            </div>
            <div class="panel">
                <h3>Assessments Activity</h3>
                <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Daily counts of assessments started and completed in the selected date range.</p>
                <div class="filters">
                    <input id="assess-start" type="date" />
                    <input id="assess-end" type="date" />
                    <button id="assess-apply">Apply</button>
                </div>
                <div id="assessments-started-chart" style="margin-bottom:20px;"></div>
                <div id="assessments-completed-chart"></div>
            </div>
        </section>

        

        <section class="panel">
            <h3>Login Heatmap</h3>
            <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Heatmap of user logins by weekday (rows) and month (columns) for a selected year.</p>
            <div class="filters">
                <input id="heatmap-year" type="number" min="2000" max="2100" />
                <button id="heatmap-apply">Apply</button>
            </div>
            <div id="login-heatmap-chart"></div>
        </section>

        <section class="panel">
            <h3>Navigation Flow (Tangled Tree)</h3>
            <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Timeline of key pages/events visited by the selected user for the chosen year.</p>
            <div class="filters">
                <select id="nav-user"></select>
                <input id="nav-year" type="number" min="2000" max="2100" />
                <button id="nav-apply">Load</button>
            </div>
            <div id="navigation-chart"></div>
        </section>

        <section class="panel">
            <h3>Daily Logins (Dot chart)</h3>
            <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Dot-and-line chart of login counts for each day in the selected month and year.</p>
            <div class="filters">
                <input id="daily-year" type="number" min="2000" max="2100" />
                <select id="daily-month">
                    <option value="1">Jan</option>
                    <option value="2">Feb</option>
                    <option value="3">Mar</option>
                    <option value="4">Apr</option>
                    <option value="5">May</option>
                    <option value="6">Jun</option>
                    <option value="7">Jul</option>
                    <option value="8">Aug</option>
                    <option value="9">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                </select>
                <button id="daily-apply">Apply</button>
            </div>
            <div id="daily-logins-chart"></div>
        </section>
        <section class="panel">
            <h3>User Analytics</h3>
            <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Summary of the selected user: overall indicators and a table of their assessments.</p>
            <div class="filters">
                <div class="autocomplete">
                    <input id="user-search" type="text" placeholder="Type a name or username..." autocomplete="off" />
                    <ul id="user-suggestions"></ul>
                </div>
                <button id="load-user">Show Details</button>
            </div>
            <section class="cards" id="user-summary-cards"></section>
            <div id="user-details"></div>
        </section>

        <section class="dual-panel">
            <div class="panel">
                <h3>CAT/MC Timing — Item Groups</h3>
                <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Average time spent (seconds) per item group across all users; limited to the 20 slowest groups.</p>
                <div id="cat-groups-chart"></div>
            </div>
            <div class="panel">
                <h3>CAT/MC Timing — Items</h3>
                <p class="muted" style="margin-top:-6px;margin-bottom:18px;max-width:720px;">Average time spent (seconds) per question item; limited to the 20 slowest items.</p>
                <div id="cat-items-chart"></div>
            </div>
        </section>

        <section class="panel">
            <h3>Top Students</h3>
            <div class="muted" style="margin-bottom:12px;">Showing the 100 best averages (traffic-light grading).</div>
            <table class="data-table" id="top-students-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Indicator</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
        
    </div>

    <script>
        const apiBase = window.location.origin;
        const charts = new DAACSCharts();
        let usersCache = [];
        let filteredUsers = [];

        function updateStatus(text, healthy) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.style.background = healthy ? 'rgba(34, 197, 94, 0.16)' : 'rgba(248, 113, 113, 0.18)';
            statusEl.style.color = healthy ? '#bbf7d0' : '#fecaca';
        }

        function showError(message, details) {
            const el = document.getElementById('status');
            el.textContent = `Error: ${message}`;
            el.style.background = 'rgba(248, 113, 113, 0.18)';
            el.style.color = '#fecaca';
            console.error(details || message);
        }

        async function fetchJSON(url) {
            const res = await fetch(url);
            if (!res.ok) {
                const msg = await res.text();
                throw new Error(`${res.status} ${res.statusText}: ${msg}`);
            }
            return res.json();
        }

        function formatNumber(value, digits = 0) {
            if (typeof value === 'number') {
                return value.toLocaleString(undefined, { maximumFractionDigits: digits });
            }
            return value;
        }

        function renderOverview(data) {
            const cards = document.getElementById('overview-cards');
            const metrics = data.system_overview || {};
            cards.innerHTML = `
                <div class="card">
                    <h3>Total Users</h3>
                    <div class="value">${formatNumber(metrics.total_users || 0)}</div>
                </div>
                <div class="card">
                    <h3>Active Users</h3>
                    <div class="value">${formatNumber(metrics.active_users || 0)}</div>
                </div>
                <div class="card">
                    <h3>Total Assessments</h3>
                    <div class="value">${formatNumber(metrics.total_assessments || 0)}</div>
                </div>
            `;
        }

        function renderPerformanceSummary(distribution) {
            const container = document.getElementById('distribution-summary');
            const ranges = (distribution && distribution.score_distribution) || [];
            if (!container) return;
            if (!ranges.length) {
                container.innerHTML = '<div class="card"><div class="value">0</div><p class="muted">No score data available.</p></div>';
                return;
            }
            const total = ranges.reduce((sum, bucket) => sum + bucket.count, 0);
            const topBucket = ranges.slice().sort((a, b) => b.count - a.count)[0];
            container.innerHTML = `
                <div class="card">
                    <h3>Total Attempts</h3>
                    <div class="value">${formatNumber(total)}</div>
                    <p class="muted">Across all assessments</p>
                </div>
                <div class="card">
                    <h3>Top Band</h3>
                    <div class="value small">${topBucket.range}</div>
                    <p class="muted">${formatNumber(topBucket.percentage, 1)}% of attempts</p>
                </div>
                <div class="card">
                    <h3>Breakdown</h3>
                    <ul class="list">
                        ${ranges.map(bucket => `<li>${bucket.range}: <strong>${formatNumber(bucket.percentage, 1)}%</strong> (${formatNumber(bucket.count)})</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderSystemDetails(data) {
            const container = document.getElementById('system-details');
            if (!container) return;
            const overview = data.system_overview || {};
            const peak = data.peak_usage_hours || [];
            const pages = data.most_visited_pages || {};

            const peakList = peak.length ? peak.map(hour => `<span class="pill">${hour}:00</span>`).join('') : '<span class="muted">No data</span>';

            const pageRows = Object.entries(pages)
                .map(([url, visits]) => `<tr><td>${url}</td><td>${formatNumber(visits)}</td></tr>`)
                .join('') || '<tr><td colspan="2"><em>No data</em></td></tr>';

            container.innerHTML = `
                <div class="grid">
                    <div>
                        <h4>Activity Highlights</h4>
                        <p><strong>Total Users:</strong> ${formatNumber(overview.total_users)}</p>
                        <p><strong>Total Assessments:</strong> ${formatNumber(overview.total_assessments)}</p>
                        <p><strong>Average Score:</strong> ${formatNumber(overview.average_score, 2)}</p>
                        <p><strong>Activity Rate:</strong> ${formatNumber(overview.activity_rate, 1)}%</p>
                    </div>
                    <div>
                        <h4>Peak Usage Hours</h4>
                        <div class="pill-group">${peakList}</div>
                    </div>
                </div>
                <h4 style="margin-top:20px;">Most Visited Pages</h4>
                <table class="data-table">
                    <thead>
                        <tr><th>URL</th><th>Visits</th></tr>
                    </thead>
                    <tbody>${pageRows}</tbody>
                </table>
            `;
        }

        function populateNavSelect(users) {
            const navSelect = document.getElementById('nav-user');
            if (!navSelect) return;
            const options = users
                .map(user => `<option value="${user.id}">${user.name || user.username} (${user.username})</option>`)
                .join('');
            navSelect.innerHTML = `<option value="">Select user...</option>` + options;
        }

        function populateNavSelect(users) {
            const navSelect = document.getElementById('nav-user');
            if (!navSelect) return;
            const options = users
                .map(user => `<option value="${user.id}">${user.name || user.username} (${user.username})</option>`)
                .join('');
            navSelect.innerHTML = `<option value="">Select user...</option>` + options;
        }

        async function loadUsers(initial = false) {
            const limit = initial ? 200 : 50;
            const data = await fetchJSON(`${apiBase}/api/users?limit=${limit}`);
            if (initial) {
                usersCache = [...data];
            }
            filteredUsers = [...data];
            return data;
        }

        async function loadNavigableUsers() {
            // Default 2020-01-01 to 2025-12-31
            const data = await fetchJSON(`${apiBase}/api/users/with_navigation?start=2020-01-01&end=2025-12-31`);
            const users = data.users || [];
            populateNavSelect(users);
            return users;
        }

        async function searchUsers(term) {
            const trimmed = (term || '').trim();
            if (!trimmed) {
                filteredUsers = [...usersCache];
                return filteredUsers.slice(0, 15);
            }
            try {
                const results = await fetchJSON(`${apiBase}/api/users?limit=50&q=${encodeURIComponent(trimmed)}`);
                filteredUsers = results;
                return results.slice(0, 15);
            } catch (err) {
                console.error('User search failed', err);
                return [];
            }
        }

        function showSuggestions(users) {
            const list = document.getElementById('user-suggestions');
            if (!list) return;
            if (!users.length) {
                list.innerHTML = '<li class="muted">No matches</li>';
                return;
            }
            list.innerHTML = users.map(user => `
                <li data-id="${user.id}">
                    <span>${user.name || user.username}</span>
                    <span class="muted">${user.username}</span>
                </li>
            `).join('');
        }

        async function loadUserAnalytics() {
            const input = document.getElementById('user-search');
            const selectedId = input.dataset.selectedUser;
            if (!selectedId) {
                document.getElementById('user-summary-cards').innerHTML = '';
                document.getElementById('user-details').innerHTML = '<div class="empty">Select a user to view details.</div>';
                return;
            }
            try {
                const data = await fetchJSON(`${apiBase}/api/users/${selectedId}/analytics`);
                renderUserSummary(data);
            } catch (err) {
                renderUserSummary({ error: err.message });
            }
        }

        function renderUserSummary(data) {
            const cardsContainer = document.getElementById('user-summary-cards');
            const detailsContainer = document.getElementById('user-details');
            if (!cardsContainer || !detailsContainer) return;
            if (!data || data.error) {
                cardsContainer.innerHTML = '';
                detailsContainer.innerHTML = `<div class="empty">${data?.error || 'No data for this user.'}</div>`;
                return;
            }

            const summary = data.summary || {};
            const assessments = data.assessments || [];

            cardsContainer.innerHTML = `
                <div class="card">
                    <h3>Name</h3>
                    <div class="value small">${data.user?.name || 'User'}</div>
                    <p class="muted">${(data.user?.roles || []).join(', ') || 'n/a'}</p>
                </div>
                <div class="card">
                    <h3>Total Assessments</h3>
                    <div class="value">${formatNumber(summary.assessments || 0)}</div>
                </div>
                <div class="card" id="user-traffic"></div>
                <div class="card">
                    <h3>Average Duration</h3>
                    <div class="value">${formatNumber(summary.average_duration || 0, 1)}</div>
                    <p class="muted">Minutes per assessment</p>
                </div>
            `;
            if (summary.score_indicator) {
                charts.renderTrafficLight('user-traffic', summary.score_indicator);
            }

            const assessmentRows = assessments.length
                ? assessments.map(ass => `
                    <tr>
                        <td>${ass.assessment_id}</td>
                        <td>${ass.status}</td>
                        <td>${formatNumber(_coerceValue(ass.overall_score), 1)}</td>
                        <td>${formatNumber(ass.duration_minutes || 0, 1)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4"><em>No assessments for this user.</em></td></tr>';

            detailsContainer.innerHTML = `
                <h4>Assessments</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Assessment ID</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Duration (min)</th>
                        </tr>
                    </thead>
                    <tbody>${assessmentRows}</tbody>
                </table>
            `;
        }

        async function loadUsersCreated(start, end) {
            const data = await fetchJSON(`${apiBase}/api/users/created${_query(start, end)}`);
            return charts.createBarChart('users-created-chart', data.series.map(d => ({ label: d.date, value: d.count })), { color: '#22d3ee' });
        }

        async function loadAssessmentsActivity(start, end) {
            const data = await fetchJSON(`${apiBase}/api/assessments/activity${_query(start, end)}`);
            charts.createBarChart('assessments-started-chart', data.started.map(d => ({ label: d.date, value: d.count })), { color: '#818cf8', emptyMessage: 'No starts in range' });
            charts.createBarChart('assessments-completed-chart', data.completed.map(d => ({ label: d.date, value: d.count })), { color: '#f97316', emptyMessage: 'No completions in range' });
        }

        async function loadAnswerCountsByYear(year) {
            const data = await fetchJSON(`${apiBase}/api/assessments/answers?year=${encodeURIComponent(year)}`);
            charts.createMonthWeekdayHeatmap('answer-counts-chart', data.buckets);
        }

        async function loadLoginHeatmapByYear(year) {
            const data = await fetchJSON(`${apiBase}/api/users/logins/heatmap?year=${encodeURIComponent(year)}`);
            charts.createMonthWeekdayHeatmap('login-heatmap-chart', data.buckets);
        }

        async function loadDailyLoginsByYear(year) {
            const data = await fetchJSON(`${apiBase}/api/users/logins/daily?year=${encodeURIComponent(year)}`);
            charts.createDotChartDaily('daily-logins-chart', data.series);
        }

        async function loadDailyLoginsByMonth(year, month) {
            try {
                const y = parseInt(year, 10);
                const m = parseInt(month, 10);
                const data = await fetchJSON(`${apiBase}/api/users/logins/daily?year=${encodeURIComponent(y)}&month=${encodeURIComponent(m)}`);
                charts.createDotChartDaily('daily-logins-chart', data.series);
            } catch (err) {
                showError(err.message, err.stack || '');
            }
        }

        async function loadNavigationFlow(userId, start, end) {
            if (!userId) {
                d3.select('#navigation-chart').html('<div class="empty">Select a user to visualize navigation.</div>');
                return;
            }
            const data = await fetchJSON(`${apiBase}/api/users/${userId}/navigation${_query(start, end)}`);
            charts.renderNavigationTree('navigation-chart', data.events);
        }

        async function loadCatMetrics() {
            const data = await fetchJSON(`${apiBase}/api/assessments/timing`);
            const groupRows = data.groups.map((row, idx) => [
                idx + 1,
                `<div class="name-with-id">${row.groupName}<span class="info" title="${row.groupId}">ℹ</span></div>`,
                `${formatNumber(row.avgSeconds, 1)} sec`
            ]);
            const itemRows = data.items.map((row, idx) => [
                idx + 1,
                `<div class="name-with-id">${row.questionName}<span class="info" title="${row.questionId}">ℹ</span></div>`,
                `${formatNumber(row.avgSeconds, 1)} sec`
            ]);
            charts.renderPairsTable('cat-groups-chart', groupRows, ['Rank', 'Group', 'Avg Seconds']);
            charts.renderPairsTable('cat-items-chart', itemRows, ['Rank', 'Item', 'Avg Seconds']);
        }

        async function loadTopStudents() {
            const data = await fetchJSON(`${apiBase}/api/users/top?limit=100`);
            const rows = (data.students || []).map((student, index) => ({
                rank: index + 1,
                name: student.name,
                username: student.username,
                indicator: student.indicator,
            }));
            const tbody = document.querySelector('#top-students-table tbody');
            if (!tbody) return;
            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td>${row.rank}</td>
                    <td>${row.name}</td>
                    <td>${row.username}</td>
                    <td class="traffic-cell"><div id="student-traffic-${row.rank}"></div><span>${row.indicator.label}</span></td>
                </tr>
            `).join('');
            rows.forEach(row => charts.renderTrafficLight(`student-traffic-${row.rank}`, row.indicator));
        }

        // Ridgeline removed

        function _coerceValue(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'object' && value !== null && 'score' in value) return value.score;
            const numeric = parseFloat(value);
            return isNaN(numeric) ? 0 : numeric;
        }

        function _query(start, end) {
            const params = [];
            if (start) params.push(`start=${start}`);
            if (end) params.push(`end=${end}`);
            return params.length ? `?${params.join('&')}` : '';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const health = await fetchJSON(`${apiBase}/api/health`);
                updateStatus(health.status === 'healthy' ? 'System Healthy' : 'System Unhealthy', health.status === 'healthy');

                const dashboard = await fetchJSON(`${apiBase}/api/system/dashboard`);
                renderOverview(dashboard);
                renderSystemDetails(dashboard);
                charts.createScoreDistribution('distribution-chart', dashboard.performance_distribution || { score_distribution: [] });
                renderPerformanceSummary(dashboard.performance_distribution);

                await loadUsers(true);
                await Promise.all([
                    loadNavigableUsers(),
                    loadAssessmentsActivity(),
                    loadUsersCreated(),
                    (() => { const y = new Date().getFullYear(); document.getElementById('heatmap-year').value = y; return loadLoginHeatmapByYear(y); })(),
                    (() => { const now = new Date(); const y = now.getFullYear(); const m = now.getMonth()+1; document.getElementById('daily-year').value = y; document.getElementById('daily-month').value = String(m); return loadDailyLoginsByMonth(y, m); })(),
                    loadCatMetrics(),
                    loadUserAnalytics(),
                    loadTopStudents(),
                ]);
                const navYearEl = document.getElementById('nav-year');
                if (navYearEl) navYearEl.value = new Date().getFullYear();
            } catch (err) {
                showError(err.message, err.stack || '');
            }

            document.getElementById('users-apply').addEventListener('click', () => {
                const start = document.getElementById('users-start').value;
                const end = document.getElementById('users-end').value;
                loadUsersCreated(start, end);
            });

            document.getElementById('assess-apply').addEventListener('click', () => {
                const start = document.getElementById('assess-start').value;
                const end = document.getElementById('assess-end').value;
                loadAssessmentsActivity(start, end);
            });

            // Answer frequency panel temporarily removed

            document.getElementById('nav-apply').addEventListener('click', () => {
                const userId = document.getElementById('nav-user').value;
                const year = document.getElementById('nav-year').value || new Date().getFullYear();
                const start = `${year}-01-01`;
                const end = `${year}-12-31`;
                loadNavigationFlow(userId, start, end);
            });

            document.getElementById('heatmap-apply').addEventListener('click', () => {
                const year = document.getElementById('heatmap-year').value || new Date().getFullYear();
                loadLoginHeatmapByYear(year);
            });

            document.getElementById('daily-apply').addEventListener('click', async () => {
                const btn = document.getElementById('daily-apply');
                btn.disabled = true;
                const year = parseInt(document.getElementById('daily-year').value || new Date().getFullYear(), 10);
                const month = parseInt(document.getElementById('daily-month').value || (new Date().getMonth()+1), 10);
                await loadDailyLoginsByMonth(year, month);
                btn.disabled = false;
            });

            const userInput = document.getElementById('user-search');
            const suggestions = document.getElementById('user-suggestions');

            let suggestionIndex = -1;

            async function handleSearchInput(term) {
                const results = await searchUsers(term);
                showSuggestions(results);
                suggestionIndex = -1;
                userInput.removeAttribute('data-selected-user');
            }

            userInput.addEventListener('input', (e) => handleSearchInput(e.target.value));

            userInput.addEventListener('keydown', (e) => {
                const items = suggestions.querySelectorAll('li[data-id]');
                if (!items.length) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    suggestionIndex = (suggestionIndex + 1) % items.length;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    suggestionIndex = (suggestionIndex - 1 + items.length) % items.length;
                } else if (e.key === 'Enter') {
                    if (suggestionIndex >= 0) {
                        e.preventDefault();
                        items[suggestionIndex].click();
                    }
                    return;
                } else {
                    return;
                }
                items.forEach((item, idx) => item.classList.toggle('active', idx === suggestionIndex));
            });

            suggestions.addEventListener('click', (e) => {
                const target = e.target.closest('li[data-id]');
                if (!target) return;
                const user = filteredUsers.find(u => u.id === target.dataset.id);
                if (user) {
                    userInput.value = `${user.name || user.username} (${user.username})`;
                    userInput.dataset.selectedUser = user.id;
                    suggestions.innerHTML = '';
                    const navSelect = document.getElementById('nav-user');
                    if (navSelect) {
                        let option = Array.from(navSelect.options).find(opt => opt.value === user.id);
                        if (!option) {
                            option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.name || user.username} (${user.username})`;
                            navSelect.appendChild(option);
                        }
                        navSelect.value = user.id;
                    }
                    const year = document.getElementById('nav-year')?.value || new Date().getFullYear();
                    const start = `${year}-01-01`;
                    const end = `${year}-12-31`;
                    loadNavigationFlow(user.id, start, end);
                }
            });

            document.addEventListener('click', (e) => {
                if (!document.querySelector('.autocomplete').contains(e.target)) {
                    suggestions.innerHTML = '';
                }
            });

            document.getElementById('load-user').addEventListener('click', loadUserAnalytics);

            // Ridgeline controls removed

            // Ridgeline autocomplete removed
        });
    </script>
</body>
</html>
